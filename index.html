<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard STEM Tour 2026</title>
    <style>
        :root {
            --primary-bg: #281495; 
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --text-muted: #718096;
            --accent-blue: #2b6cb0;
            --danger: #ff4d4d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background-color: var(--primary-bg); 
            color: var(--text-main);
            min-height: 100vh;
            padding: 15px;
        }

        .hidden { display: none !important; }

        /* --- LOGIN --- */
        .login-box { 
            background: var(--card-bg); max-width: 400px; margin: 40px auto; 
            padding: 30px; border-radius: 28px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); text-align: center; 
        }
        .login-logo { width: 150px; height: 150px; object-fit: contain; margin-bottom: 20px; border-radius: 50%; }
        input[type="email"] { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; margin: 20px 0; font-size: 16px; outline: none; }

        /* --- DASHBOARD ESTRUCTURA --- */
        .dashboard-container { max-width: 1100px; margin: 0 auto; }
        
        /* FILA SUPERIOR (ESCRITORIO) */
        .top-row { 
            display: grid; 
            grid-template-columns: 1.5fr 1fr 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 25px; 
        }

        .card { 
            background: var(--card-bg); border-radius: 20px; padding: 18px; 
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center;
        }
        
        .logout-btn { 
            background: var(--danger); color: white; border: none; padding: 10px; 
            border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 13px; margin-top: 10px;
            transition: background 0.3s;
        }
        .logout-btn:hover { background: #cc0000; }

        .stat-label { font-size: 10px; color: var(--text-muted); font-weight: 800; text-transform: uppercase; }
        .stat-value { font-size: 18px; font-weight: bold; margin-top: 5px; color: var(--accent-blue); }

        /* --- DISE√ëO M√ìVIL (OCULTO POR DEFECTO) --- */
        .mobile-only { display: none; }

        @media (max-width: 850px) {
            .top-row { display: none; } /* Oculta tarjetas de escritorio */
            .mobile-only { display: block; } /* Muestra elementos de m√≥vil */
            
            .profile-mini-card {
                background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px;
                display: flex; justify-content: space-between; align-items: center;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            }

            .dropdown-trigger {
                background: rgba(255,255,255,0.15); color: white; padding: 15px;
                border-radius: 15px; text-align: center; font-weight: bold;
                border: 1px solid rgba(255,255,255,0.3); cursor: pointer; width: 100%;
                margin-bottom: 20px;
            }

            .dropdown-content {
                background: white; border-radius: 15px; padding: 15px;
                margin-top: -15px; margin-bottom: 20px; display: none;
                box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            }
            .dropdown-item { padding: 10px 0; border-bottom: 1px solid #eee; }
            .dropdown-item:last-child { border-bottom: none; }
        }

        /* --- CIUDADES --- */
        .cities-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .city-card { background: var(--card-bg); border-radius: 24px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .city-banner { padding: 15px; color: white; font-weight: bold; text-align: center; }
        .banner-cali { background: #ef4444; }
        .banner-manizales { background: #3b82f6; }
        .banner-bogota { background: #1e3a8a; }
        .city-content { padding: 20px; }
        .activity-row { display: flex; margin-bottom: 8px; font-size: 14px; color: #4a5568; align-items: center; }
        .check { color: #10b981; margin-right: 8px; font-weight: bold; }

        .btn-main { background: #2d3748; color: white; border: none; padding: 16px; width: 100%; border-radius: 18px; font-weight: bold; cursor: pointer; }

        /* --- MODAL --- */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; width: 98%; height: 95%; border-radius: 15px; position: relative; }
        .close-pdf-btn { position: absolute; top: 10px; right: 10px; background: var(--danger); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; z-index: 2100; cursor: pointer; }
        iframe { width: 100%; height: 100%; border: none; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-bg); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loginSection" class="login-box">
        <img src="https://www-s3-live.kent.edu/s3fs-root/s3fs-public/logo-color_2.png?VersionId=OcKaWld8QObkWdnw5xk7jKvg2ZESYU6q" alt="Logo STEM" class="login-logo">
        <h2>STEM Tour 2026</h2>
        <input type="email" id="emailInput" placeholder="tu.email@universidad.edu">
        <div id="loader" class="loader hidden"></div>
        <button class="btn-main" style="background:var(--primary-bg)" onclick="startLogin()">Ingresar</button>
        <p id="errorMsg" style="color:var(--danger); margin-top:15px; display:none;">Email no encontrado.</p>
    </div>

    <div id="dashboardSection" class="dashboard-container hidden">
        
        <div class="mobile-only">
            <div class="profile-mini-card">
                <div>
                    <h3 id="mobileUserName" style="font-size: 15px;">-</h3>
                    <p id="mobileUserInst" style="font-size: 11px; color: var(--text-muted);"></p>
                </div>
                <button class="logout-btn" style="margin:0; padding: 6px 12px;" onclick="location.reload()">Salir</button>
            </div>

            <button class="dropdown-trigger" onclick="toggleDropdown()">‚ÑπÔ∏è Informaci√≥n del Perfil ‚ñº</button>
            <div id="infoDropdown" class="dropdown-content">
                <div class="dropdown-item">
                    <p class="stat-label">Ciudades Activas</p>
                    <p class="stat-value" id="mStatCity">0</p>
                </div>
                <div class="dropdown-item">
                    <p class="stat-label">Servicio Traductor</p>
                    <p class="stat-value" id="mStatTrans">Buscando...</p>
                </div>
                <div class="dropdown-item">
                    <p class="stat-label">Email registrado</p>
                    <p id="mStatEmail" style="font-size: 13px; margin-top:5px;">-</p>
                </div>
            </div>
        </div>

        <div class="top-row">
            <div class="card">
                <p class="stat-label">Perfil</p>
                <h2 id="userName" style="font-size: 16px; margin-top:5px;">-</h2>
                <p id="userEmail" style="font-size: 11px; color: var(--primary-bg); font-weight: bold;"></p>
                <button class="logout-btn" onclick="location.reload()">Cerrar Sesi√≥n</button>
            </div>
            <div class="card">
                <p class="stat-label">Ciudades</p>
                <div class="stat-value" id="statCityCount">0</div>
            </div>
            <div class="card">
                <p class="stat-label">Instituci√≥n</p>
                <div class="stat-value" id="userInstShort" style="font-size: 13px;">-</div>
            </div>
            <div class="card">
                <p class="stat-label">Traductor</p>
                <div class="stat-value" id="translatorStatus">Buscando...</div>
            </div>
        </div>

        <div id="itineraryContent" class="cities-grid"></div>

        <div style="margin: 30px auto; text-align: center;">
            <button class="btn-main" onclick="openPdf(1)">üìñ Gu√≠a General de Actividades (PDF)</button>
        </div>
    </div>

    <div id="pdfModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-pdf-btn" onclick="closeModal()">‚úï</button>
            <iframe id="pdfFrame" src=""></iframe>
        </div>
    </div>

<script>
    const SHEET_REGISTRO = "1_N6zhjoE1zCmLpZN3-DG1_uCvygdoDOISHwodqEJ5bs";
    const SHEET_COORDINACION = "1WKcECT2gPKtsN__0CGP5Rren9ZdlWgY7";
    const PDF_URL_BASE = "https://drive.google.com/file/d/12tGm6rnFONa7b4qlFmvxCSQBNQRwE-Wl/preview";

    let userData = null;

    function toggleDropdown() {
        const content = document.getElementById('infoDropdown');
        content.style.display = content.style.display === 'block' ? 'none' : 'block';
    }

    async function fetchTable(sheetId, query, sheetName = "") {
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tq=${encodeURIComponent(query)}${sheetName ? `&sheet=${sheetName}` : ''}`;
        const response = await fetch(url);
        const text = await response.text();
        return JSON.parse(text.substring(47, text.length - 2)).table;
    }

    async function startLogin() {
        const email = document.getElementById('emailInput').value.toLowerCase().trim();
        if(!email) return;
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('errorMsg').style.display = 'none';
        
        try {
            const regTable = await fetchTable(SHEET_REGISTRO, "SELECT A, C, D, F, K, L, M");
            const row = regTable.rows.find(r => r.c[3]?.v?.toLowerCase().trim() === email);

            if (!row) {
                document.getElementById('errorMsg').style.display = 'block';
                document.getElementById('loader').classList.add('hidden');
                return;
            }

            userData = {
                inst: row.c[0].v,
                name: row.c[2].v,
                email: email,
                cities: { Cali: row.c[4]?.v === 'Yes', Manizales: row.c[5]?.v === 'Yes', Bogota: row.c[6]?.v === 'Yes' }
            };
            renderDashboard(email);
        } catch (e) { 
            alert("Error de conexi√≥n"); 
            document.getElementById('loader').classList.add('hidden'); 
        }
    }

    async function renderDashboard(email) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');
        
        // Cargar datos en Desktop
        document.getElementById('userName').innerText = userData.name;
        document.getElementById('userEmail').innerText = userData.email;
        document.getElementById('userInstShort').innerText = userData.inst;
        
        // Cargar datos en M√≥vil
        document.getElementById('mobileUserName').innerText = userData.name;
        document.getElementById('mobileUserInst').innerText = userData.inst;
        document.getElementById('mStatEmail').innerText = userData.email;

        const container = document.getElementById('itineraryContent');
        container.innerHTML = "";

        const citySpecs = [
            { name: 'Cali', class: 'banner-cali', cols: [7, 8, 9], transCol: 10 }, 
            { name: 'Manizales', class: 'banner-manizales', cols: [7, 8, 9, 10, 11], transCol: 5 }, 
            { name: 'Bogota', class: 'banner-bogota', cols: [7, 8], transCol: 9 }, 
        ];

        let count = 0;
        let globalTranslator = "No asignado";

        for (const city of citySpecs) {
            if (userData.cities[city.name]) {
                count++;
                const cityTable = await fetchTable(SHEET_COORDINACION, "SELECT *", city.name);
                const userRow = cityTable.rows.find(r => r.c[5]?.v?.toLowerCase().trim() === email);

                if (userRow) {
                    if (globalTranslator === "No asignado" || globalTranslator === "") {
                        globalTranslator = userRow.c[city.transCol]?.v || "No asignado";
                    }
                    let actHtml = "";
                    city.cols.forEach(colIdx => {
                        if (userRow.c[colIdx]?.v === "Yes") {
                            const label = cityTable.cols[colIdx].label.replace(/\b(Yes|No)\b/gi, '').trim();
                            actHtml += `<div class="activity-row"><span class="check">‚úì</span>${label}</div>`;
                        }
                    });
                    container.innerHTML += `
                        <div class="city-card">
                            <div class="city-banner ${city.class}">üìç ${city.name}</div>
                            <div class="city-content">
                                ${actHtml || '<p style="color:#999; font-size:13px;">Sin actividades adicionales registradas.</p>'}
                            </div>
                        </div>`;
                }
            }
        }
        document.getElementById('statCityCount').innerText = count;
        document.getElementById('mStatCity').innerText = count;
        document.getElementById('translatorStatus').innerText = globalTranslator;
        document.getElementById('mStatTrans').innerText = globalTranslator;
    }

    function openPdf(page) { 
        document.getElementById('pdfFrame').src = `${PDF_URL_BASE}#page=${page}`; 
        document.getElementById('pdfModal').classList.remove('hidden'); 
    }
    function closeModal() { 
        document.getElementById('pdfModal').classList.add('hidden'); 
        document.getElementById('pdfFrame').src = ""; 
    }
</script>
</body>
</html>
