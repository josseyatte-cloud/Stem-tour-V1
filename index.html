<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard STEM Tour 2026</title>
    <style>
        :root {
            --primary-bg: #281495; 
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --text-muted: #718096;
            --accent-blue: #2b6cb0;
            --danger: #ff4d4d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background-color: var(--primary-bg); 
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
        }

        .hidden { display: none !important; }

        /* --- LOGIN --- */
        .login-box { 
            background: var(--card-bg); max-width: 420px; margin: 60px auto; 
            padding: 40px; border-radius: 28px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); text-align: center; 
        }
        
        .login-logo {
            width: 200px;
            height: 200px;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 50%;
        }

        .login-box h2 { color: var(--text-main); margin-bottom: 10px; font-size: 24px; }
        
        input[type="email"] { 
            width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; 
            margin: 20px 0; font-size: 16px; outline: none; transition: border-color 0.3s;
        }
        input[type="email"]:focus { border-color: var(--primary-bg); }

        /* --- DASHBOARD --- */
        .dashboard-container { max-width: 1100px; margin: 0 auto; }
        .top-row { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        
        .card { 
            background: var(--card-bg); border-radius: 20px; padding: 20px; 
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); position: relative; 
            display: flex; flex-direction: column; justify-content: center;
        }
        
        .logout-btn { 
            background: var(--danger); color: white; border: none; padding: 8px 15px; 
            border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 12px;
            position: absolute; top: 20px; right: 20px;
        }

        .stat-label { font-size: 11px; color: var(--text-muted); font-weight: bold; text-transform: uppercase; }
        .stat-value { font-size: 18px; font-weight: bold; margin-top: 5px; color: var(--accent-blue); }

        /* --- CIUDADES --- */
        .cities-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .city-card { 
            background: var(--card-bg); border-radius: 24px; overflow: hidden; 
            display: flex; flex-direction: column; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .city-banner { padding: 18px; color: white; font-weight: bold; text-align: center; font-size: 1.2em; }
        .banner-cali { background: #ef4444; }
        .banner-manizales { background: #3b82f6; }
        .banner-bogota { background: #1e3a8a; }

        .city-content { padding: 25px; flex-grow: 1; }
        .activity-row { display: flex; align-items: flex-start; margin-bottom: 12px; font-size: 14px; color: #4a5568; }
        .check { color: #10b981; margin-right: 10px; font-weight: bold; }

        /* --- BOTONES --- */
        .btn-main { 
            background: #2d3748; color: white; border: none; padding: 18px; 
            width: 100%; border-radius: 18px; cursor: pointer; font-weight: bold; font-size: 16px;
            transition: all 0.3s;
        }
        .btn-main:hover { background: #1a202c; transform: translateY(-2px); }

        /* --- MODAL PDF --- */
        .modal { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content { 
            background: white; width: 95%; height: 90%; border-radius: 24px; 
            position: relative; overflow: hidden;
        }
        .close-pdf-btn { 
            position: absolute; top: 15px; right: 15px; background: var(--danger); 
            color: white; border: none; width: 40px; height: 40px; border-radius: 50%; 
            font-size: 20px; font-weight: bold; cursor: pointer; z-index: 2100;
            display: flex; justify-content: center; align-items: center;
        }
        iframe { width: 100%; height: 100%; border: none; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-bg); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loginSection" class="login-box">
        <img src="https://www-s3-live.kent.edu/s3fs-root/s3fs-public/logo-color_2.png?VersionId=OcKaWld8QObkWdnw5xk7jKvg2ZESYU6q" alt="Logo STEM" class="login-logo">
        <h2>STEM Tour 2026</h2>
        <p>Dashboard de Representantes</p>
        <input type="email" id="emailInput" placeholder="tu.email@universidad.edu">
        <div id="loader" class="loader hidden"></div>
        <button class="btn-main" style="background:var(--primary-bg)" onclick="startLogin()">Ingresar</button>
        <p id="errorMsg" style="color:var(--danger); margin-top:15px; font-weight:600; display:none;">Email no encontrado.</p>
    </div>

    <div id="dashboardSection" class="dashboard-container hidden">
        <div class="top-row">
            <div class="card">
                
                <p class="stat-label">Perfil</p>
                <h2 id="userName" style="margin-top:5px; font-size: 18px;">-</h2>
                <p id="userEmail" style="font-size: 11px; color: var(--primary-bg); font-weight: bold;"></p>
            </div>
            <div class="card">
                <p class="stat-label">Ciudades</p>
                <div class="stat-value" id="statCityCount">0</div>
            </div>
            <div class="card">
                <p class="stat-label">Instituci√≥n</p>
                <div class="stat-value" id="userInstShort" style="font-size: 13px;">-</div>
            </div>
            <div class="card">
                <p class="stat-label">Traductor</p>
                <div class="stat-value" id="translatorStatus">Buscando...</div>
            </div>
            <button class="logout-btn" onclick="location.reload()">Salir</button>
        </div>

        <div id="itineraryContent" class="cities-grid"></div>

        <div style="margin: 40px auto; max-width: 500px; text-align: center;">
            <button class="btn-main" onclick="openPdf(1)">
                üìñ Ver Gu√≠a General de Actividades (PDF)
            </button>
        </div>
    </div>

    <div id="pdfModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-pdf-btn" onclick="closeModal()">‚úï</button>
            <iframe id="pdfFrame" src=""></iframe>
        </div>
    </div>

<script>
    const SHEET_REGISTRO = "1_N6zhjoE1zCmLpZN3-DG1_uCvygdoDOISHwodqEJ5bs";
    const SHEET_COORDINACION = "1WKcECT2gPKtsN__0CGP5Rren9ZdlWgY7";
    const PDF_URL_BASE = "https://drive.google.com/file/d/12tGm6rnFONa7b4qlFmvxCSQBNQRwE-Wl/preview";

    let userData = null;

    async function fetchTable(sheetId, query, sheetName = "") {
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tq=${encodeURIComponent(query)}${sheetName ? `&sheet=${sheetName}` : ''}`;
        const response = await fetch(url);
        const text = await response.text();
        return JSON.parse(text.substring(47, text.length - 2)).table;
    }

    function cleanName(name) {
        return name ? name.replace(/\b(Yes|No)\b/gi, '').trim() : "Actividad";
    }

    async function startLogin() {
        const email = document.getElementById('emailInput').value.toLowerCase().trim();
        if(!email) return;
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('errorMsg').style.display = 'none';
        
        try {
            const regTable = await fetchTable(SHEET_REGISTRO, "SELECT A, C, D, F, K, L, M");
            const row = regTable.rows.find(r => r.c[3]?.v?.toLowerCase().trim() === email);

            if (!row) {
                document.getElementById('errorMsg').style.display = 'block';
                document.getElementById('loader').classList.add('hidden');
                return;
            }

            userData = {
                inst: row.c[0].v,
                name: row.c[2].v,
                email: email,
                cities: { Cali: row.c[4]?.v === 'Yes', Manizales: row.c[5]?.v === 'Yes', Bogota: row.c[6]?.v === 'Yes' }
            };
            renderDashboard(email);
        } catch (e) { 
            alert("Error de conexi√≥n");
            document.getElementById('loader').classList.add('hidden');
        }
    }

    async function renderDashboard(email) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');
        document.getElementById('userName').innerText = userData.name;
        document.getElementById('userEmail').innerText = userData.email;
        document.getElementById('userInstShort').innerText = userData.inst;

        const container = document.getElementById('itineraryContent');
        container.innerHTML = "";

        const citySpecs = [
            { name: 'Cali', class: 'banner-cali', cols: [7, 8, 9], transCol: 10 }, // Columna K
            { name: 'Manizales', class: 'banner-manizales', cols: [7, 8, 9, 10, 11], transCol: 5 }, // Columna F
            { name: 'Bogota', class: 'banner-bogota', cols: [7, 8], transCol: 9 }, // Columna J
        ];

        let count = 0;
        let globalTranslator = "No asignado";

        for (const city of citySpecs) {
            if (userData.cities[city.name]) {
                count++;
                const cityTable = await fetchTable(SHEET_COORDINACION, "SELECT *", city.name);
                const userRow = cityTable.rows.find(r => r.c[5]?.v?.toLowerCase().trim() === email);

                if (userRow) {
                    // Actualizar estado del traductor (toma el primero que encuentre de las ciudades activas)
                    if (globalTranslator === "No asignado" || globalTranslator === "") {
                        globalTranslator = userRow.c[city.transCol]?.v || "No asignado";
                    }

                    let actHtml = "";
                    city.cols.forEach(colIdx => {
                        if (userRow.c[colIdx]?.v === "Yes") {
                            const title = cleanName(cityTable.cols[colIdx].label);
                            actHtml += `<div class="activity-row"><span class="check">‚úì</span>${title}</div>`;
                        }
                    });

                    container.innerHTML += `
                        <div class="city-card">
                            <div class="city-banner ${city.class}">üìç ${city.name}</div>
                            <div class="city-content">${actHtml || '<p style="color:#999">No hay actividades adicionales.</p>'}</div>
                        </div>
                    `;
                }
            }
        }
        document.getElementById('statCityCount').innerText = count;
        document.getElementById('translatorStatus').innerText = globalTranslator;
    }

    function openPdf(page) {
        document.getElementById('pdfFrame').src = `${PDF_URL_BASE}#page=${page}`;
        document.getElementById('pdfModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('pdfModal').classList.add('hidden');
        document.getElementById('pdfFrame').src = "";
    }
</script>
</body>
</html>
